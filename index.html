<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento da Viagem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        #modal.show #modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto max-w-4xl p-5 sm:p-8">

        <main class="space-y-8 sm:space-y-10">
            <section id="status" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold mb-2">Quadro de Pagamentos</h2>
                <div class="text-slate-600 mb-6 space-y-2">
                    <p class="text-sm sm:text-base">Esta tabela Ã© atualizada apÃ³s a confirmaÃ§Ã£o manual do pagamento.</p>
                    <h3> <b>ðŸš¨ Ana Rafaela e Ana ProenÃ§a, voces pagam R$ 93,28 no mes de outubro ta bom ðŸ˜˜</b> </h3>
                </div>
                <div class="w-full h-80 sm:h-96 rounded-xl border border-slate-200 overflow-hidden">
                    <iframe 
                        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vThipJt6e139yg3-bBIRkQxlxjuEHGC0x6fIKvqgCR9e6hNVG09Y5-Z4e2JK6BJCu4ReZNXDjs1a-hF/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false"
                        width="100%" 
                        height="100%" 
                        frameborder="0">
                        A carregar planilha...
                    </iframe>
                </div>

                <div class="mt-6 pt-6 border-t border-slate-200">
                    <label class="block text-sm font-medium text-slate-700 mb-2 text-center">Chave PIX </label>
                    <div class="flex justify-center items-center gap-2">
                        
                        <button 
                            id="copyButton" 
                            title="Clique para copiar" 
                            class="flex items-center justify-center gap-3 px-4 py-2 rounded-lg font-medium text-base sm:text-lg bg-slate-200 text-sky-600 hover:bg-teal-100 hover:text-teal-600 transition-all duration-200">
                            
                            <span id="pix-email" class="truncate">arthur.rosisca@hotmail.com</span>
                            
                            <i data-feather="copy" class="w-5 h-5 flex-shrink-0"></i>
                        </button>
                        </div>
                    <span id="copyFeedback" class="text-sm text-green-600 mt-2 block h-4 text-center transition-opacity duration-300 opacity-0">
                        Copiado!
                    </span>
                </div>
                </section>

            <section id="formulario" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold mb-6">Enviar Comprovante</h2>
                <form id="paymentForm" class="space-y-6">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-slate-700 mb-1">Nome</label>
                        <input type="text" id="nome" name="nome" required class="mt-1 block w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition">
                    </div>
                    <div>
                        <label for="comprovante" class="block text-sm font-medium text-slate-700 mb-1">Comprovativo (Print ou PDF)</label>
                        <div id="file-upload-area" class="relative border-2 border-dashed border-slate-300 rounded-xl p-10 text-center cursor-pointer transition hover:border-sky-500 hover:bg-sky-50">
                            <input type="file" id="comprovante" name="comprovante" accept="image/*,.pdf" required class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="flex flex-col items-center">
                                <i data-feather="upload-cloud" class="w-12 h-12 text-slate-400"></i>
                                <p class="mt-2 text-slate-600 text-sm sm:text-base">Clique para <span class="font-semibold text-sky-500">enviar </span> ou <span class="font-semibold text-sky-500">arraste </span> aqui.</p>
                                <p id="fileNameDisplay" class="mt-4 font-medium text-teal-600 text-sm"></p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit" id="submitButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-gradient-to-r from-teal-500 to-sky-500 hover:shadow-lg hover:-translate-y-0.5 transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                            <span id="buttonText">Confirmar Envio</span>
                            <svg id="spinner" class="animate-spin h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </form>
                <div id="statusMessage" class="mt-6 text-center p-4 rounded-lg hidden transition-all duration-300"></div>
            </section>
        </main>

    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 text-center transform scale-95 transition-all duration-300">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <i data-feather="check" class="w-10 h-10 text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-slate-800">Sucesso!</h3>
            <p id="modalMessage" class="text-slate-600 mt-2 mb-6"></p>
            <button id="closeModalButton" class="w-full bg-teal-500 text-white py-2 px-4 rounded-lg hover:bg-teal-600 transition">
                Fechar
            </button>
        </div>
    </div>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxwwgc7wruZNDf9lZnDA0Xd8Fziws-CiBsUzAn180JISJM8sQH9h9NUW-wIQKvus5T3nw/exec';

        const form = document.getElementById('paymentForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const statusMessage = document.getElementById('statusMessage');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // FunÃ§Ã£o para ativar estado de carregamento
        function setLoadingState(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.textContent = "Enviando...";
                spinner.classList.remove('hidden');
            } else {
                submitButton.disabled = false;
                buttonText.textContent = "Confirmar Envio";
                spinner.classList.add('hidden');
            }
        }

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.add('show');
            feather.replace(); 
        }

        function closeModal() {
            modal.classList.remove('show');
        }

        closeModalButton.addEventListener('click', closeModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const arquivo = document.getElementById('comprovante').files[0];

            // Reset da mensagem de status
            statusMessage.className = 'mt-6 text-center p-4 rounded-lg hidden';

            // ValidaÃ§Ã£o bÃ¡sica
            if (!nome || !arquivo) {
                statusMessage.textContent = "Por favor, preencha todos os campos.";
                statusMessage.className = 'mt-6 text-center p-4 rounded-md bg-yellow-100 text-yellow-800';
                return;
            }

            // Ativar estado de carregamento
            setLoadingState(true);

            try {
                // Usando Promise para lidar com o FileReader de forma mais limpa
                const fileData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = () => {
                        resolve({
                            nome: nome,
                            arquivo: reader.result,
                            nomeArquivo: arquivo.name,
                            tipoArquivo: arquivo.type
                        });
                    };
                    
                    reader.onerror = () => {
                        reject(new Error("NÃ£o foi possÃ­vel processar o ficheiro selecionado."));
                    };
                    
                    reader.readAsDataURL(arquivo);
                });

                // Enviar para a API
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(fileData),
                });

                if (!response.ok) {
                    throw new Error(`Erro no servidor (Status: ${response.status}).`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showModal(result.message);
                    form.reset();
                    document.getElementById('fileNameDisplay').textContent = '';
                } else {
                    throw new Error(result.message || "Erro desconhecido ao enviar.");
                }

            } catch (error) {
                statusMessage.textContent = `Erro: ${error.message}. Tente novamente.`;
                statusMessage.className = 'mt-6 text-center p-4 rounded-md bg-red-100 text-red-800';
            } finally {
                // Desativar estado de carregamento (independente de sucesso ou erro)
                setLoadingState(false);
            }
        });

        // LÃ³gica do upload de arquivo (mantida igual)
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('comprovante');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('border-sky-500', 'bg-sky-50');
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('border-sky-500', 'bg-sky-50');
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('border-sky-500', 'bg-sky-50');
            fileInput.files = e.dataTransfer.files;
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });


        // ======================================
        // ==== SCRIPT PIX ATUALIZADO ====
        // ======================================
        const copyButton = document.getElementById('copyButton');
        const pixEmailElement = document.getElementById('pix-email'); // O <span> dentro do botÃ£o
        const copyFeedback = document.getElementById('copyFeedback');
        let copyTimeout = null; // VariÃ¡vel para controlar o timeout

        // --- FunÃ§Ãµes de Feedback Visual ---

        function showCopySuccess() {
            // Limpa timeout anterior se houver
            if (copyTimeout) clearTimeout(copyTimeout);

            copyFeedback.textContent = 'Copiado!';
            copyFeedback.classList.remove('opacity-0', 'text-red-500'); // Garante que nÃ£o estÃ¡ vermelho
            copyFeedback.classList.add('text-green-600');
            
            // Mudar o Ã­cone para "check"
            // O Ã­cone agora estÃ¡ dentro do botÃ£o
            const iconElement = copyButton.querySelector('i');
            if(iconElement) {
                iconElement.remove();
                copyButton.insertAdjacentHTML('beforeend', '<i data-feather="check" class="w-5 h-5 flex-shrink-0 text-green-600"></i>');
                feather.replace(); // Renderiza o novo Ã­cone
            }

            // Resetar depois de 2 segundos
            copyTimeout = setTimeout(() => {
                copyFeedback.classList.add('opacity-0');
                // Voltar o Ã­cone para "copy"
                const checkIcon = copyButton.querySelector('i');
                if(checkIcon) {
                    checkIcon.remove();
                    copyButton.insertAdjacentHTML('beforeend', '<i data-feather="copy" class="w-5 h-5 flex-shrink-0"></i>');
                    feather.replace(); // Renderiza o Ã­cone original
                }
            }, 2000);
        }

        function showCopyError(err) {
            console.error('Falha ao copiar: ', err);
            // Limpa timeout anterior se houver
            if (copyTimeout) clearTimeout(copyTimeout);

            copyFeedback.textContent = 'Falha ao copiar.';
            copyFeedback.classList.add('text-red-500'); // Mostra erro em vermelho
            copyFeedback.classList.remove('opacity-0', 'text-green-600');

            // Resetar depois de 2 segundos
            copyTimeout = setTimeout(() => {
                copyFeedback.classList.add('opacity-0');
            }, 2000);
        }

        // --- FunÃ§Ã£o de CÃ³pia Fallback (ClÃ¡ssica) ---
        function copyTextFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // Tornar invisÃ­vel e fora da tela
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            textArea.style.opacity = '0';

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select(); // Seleciona o texto

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('Fallback copy command failed');
                }
            } catch (err) {
                showCopyError(err);
            }

            document.body.removeChild(textArea); // Limpa o elemento
        }
        
        // --- FunÃ§Ã£o de aÃ§Ã£o de cÃ³pia reutilizÃ¡vel ---
        function handleCopyAction() {
            // Pega o texto do <span> que estÃ¡ dentro do botÃ£o
            const pixEmail = pixEmailElement.textContent;

            // Verifica se a API moderna (navigator.clipboard) estÃ¡ disponÃ­vel
            if (navigator.clipboard && window.isSecureContext) {
                // Tenta usar a API moderna
                navigator.clipboard.writeText(pixEmail).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    // Se a API moderna falhar (ex: permissÃ£o negada), tenta o fallback
                    console.warn('API moderna falhou, tentando fallback.', err);
                    copyTextFallback(pixEmail);
                });
            } else {
                // Se a API moderna nÃ£o estiver disponÃ­vel (ex: HTTP ou file://),
                // usa o fallback diretamente.
                console.warn('Contexto inseguro ou API indisponÃ­vel. Usando fallback.');
                copyTextFallback(pixEmail);
            }
        }

        // --- Event Listeners Principais ---
        // Agora SÃ“ o botÃ£o precisa do listener
        copyButton.addEventListener('click', handleCopyAction);
        
        // ====================================
        // ==== SCRIPT PIX TERMINA AQUI ====
        // ====================================


        feather.replace();
    </script>
</body>
</html>