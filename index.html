<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento da Viagem</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Biblioteca de Ícones (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        #modal.show #modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto max-w-4xl p-5 sm:p-8">

        <main class="space-y-8 sm:space-y-10">
            <!-- Secção do Quadro de Pagamentos -->
            <section id="status" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold mb-2">Quadro de Pagamentos</h2>
                <div class="text-slate-600 mb-6 space-y-2">
                    <p class="text-sm sm:text-base">Esta tabela é atualizada após a confirmação manual do pagamento.</p>
                </div>
                <div class="w-full h-80 sm:h-96 rounded-xl border border-slate-200 overflow-hidden">
                    <iframe 
                        src="https://docs.google.com/spreadsheets/d/e/2PACX-1vThipJt6e139yg3-bBIRkQxlxjuEHGC0x6fIKvqgCR9e6hNVG09Y5-Z4e2JK6BJCu4ReZNXDjs1a-hF/pubhtml?gid=0&amp;single=true&amp;widget=true&amp;headers=false"
                        width="100%" 
                        height="100%" 
                        frameborder="0">
                        A carregar planilha...
                    </iframe>
                </div>
            </section>

            <!-- Secção do Formulário -->
            <section id="formulario" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <h2 class="text-xl sm:text-2xl font-bold mb-6">Enviar Comprovante</h2>
                <form id="paymentForm" class="space-y-6">
                    <div>
                        <label for="nome" class="block text-sm font-medium text-slate-700 mb-1">Nome</label>
                        <input type="text" id="nome" name="nome" required class="mt-1 block w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition">
                    </div>
                    <div>
                        <label for="comprovante" class="block text-sm font-medium text-slate-700 mb-1">Comprovativo (Print ou PDF)</label>
                        <div id="file-upload-area" class="relative border-2 border-dashed border-slate-300 rounded-xl p-10 text-center cursor-pointer transition hover:border-sky-500 hover:bg-sky-50">
                            <input type="file" id="comprovante" name="comprovante" accept="image/*,.pdf" required class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="flex flex-col items-center">
                                <i data-feather="upload-cloud" class="w-12 h-12 text-slate-400"></i>
                                <p class="mt-2 text-slate-600 text-sm sm:text-base">Clique para <span class="font-semibold text-sky-500">enviar </span> ou <span class="font-semibold text-sky-500">arraste </span> aqui.</p>
                                <p id="fileNameDisplay" class="mt-4 font-medium text-teal-600 text-sm"></p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button type="submit" id="submitButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-gradient-to-r from-teal-500 to-sky-500 hover:shadow-lg hover:-translate-y-0.5 transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                            <span id="buttonText">Confirmar Envio</span>
                            <svg id="spinner" class="animate-spin h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </form>
                <div id="statusMessage" class="mt-6 text-center p-4 rounded-lg hidden transition-all duration-300"></div>
            </section>
        </main>

    </div>

    <!-- Pop-up Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 text-center transform scale-95 transition-all duration-300">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <i data-feather="check" class="w-10 h-10 text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-slate-800">Sucesso!</h3>
            <p id="modalMessage" class="text-slate-600 mt-2 mb-6"></p>
            <button id="closeModalButton" class="w-full bg-teal-500 text-white py-2 px-4 rounded-lg hover:bg-teal-600 transition">
                Fechar
            </button>
        </div>
    </div>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxwwgc7wruZNDf9lZnDA0Xd8Fziws-CiBsUzAn180JISJM8sQH9h9NUW-wIQKvus5T3nw/exec';

        const form = document.getElementById('paymentForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const statusMessage = document.getElementById('statusMessage');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // Função para ativar estado de carregamento
        function setLoadingState(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.textContent = "Enviando...";
                spinner.classList.remove('hidden');
            } else {
                submitButton.disabled = false;
                buttonText.textContent = "Confirmar Envio";
                spinner.classList.add('hidden');
            }
        }

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.add('show');
            feather.replace(); 
        }

        function closeModal() {
            modal.classList.remove('show');
        }

        closeModalButton.addEventListener('click', closeModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value;
            const arquivo = document.getElementById('comprovante').files[0];

            // Reset da mensagem de status
            statusMessage.className = 'mt-6 text-center p-4 rounded-lg hidden';

            // Validação básica
            if (!nome || !arquivo) {
                statusMessage.textContent = "Por favor, preencha todos os campos.";
                statusMessage.className = 'mt-6 text-center p-4 rounded-md bg-yellow-100 text-yellow-800';
                return;
            }

            // Ativar estado de carregamento
            setLoadingState(true);

            try {
                // Usando Promise para lidar com o FileReader de forma mais limpa
                const fileData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = () => {
                        resolve({
                            nome: nome,
                            arquivo: reader.result,
                            nomeArquivo: arquivo.name,
                            tipoArquivo: arquivo.type
                        });
                    };
                    
                    reader.onerror = () => {
                        reject(new Error("Não foi possível processar o ficheiro selecionado."));
                    };
                    
                    reader.readAsDataURL(arquivo);
                });

                // Enviar para a API
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify(fileData),
                });

                if (!response.ok) {
                    throw new Error(`Erro no servidor (Status: ${response.status}).`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showModal(result.message);
                    form.reset();
                    document.getElementById('fileNameDisplay').textContent = '';
                } else {
                    throw new Error(result.message || "Erro desconhecido ao enviar.");
                }

            } catch (error) {
                statusMessage.textContent = `Erro: ${error.message}. Tente novamente.`;
                statusMessage.className = 'mt-6 text-center p-4 rounded-md bg-red-100 text-red-800';
            } finally {
                // Desativar estado de carregamento (independente de sucesso ou erro)
                setLoadingState(false);
            }
        });

        // Lógica do upload de arquivo (mantida igual)
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('comprovante');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('border-sky-500', 'bg-sky-50');
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('border-sky-500', 'bg-sky-50');
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('border-sky-500', 'bg-sky-50');
            fileInput.files = e.dataTransfer.files;
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            }
        });
        
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = '';
            }
        });

        feather.replace();
    </script>
</body>
</html>